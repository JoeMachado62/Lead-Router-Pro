<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Application - Working Version</title>
    <style>
        /* Base styles */
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
        }
        
        /* Widget container */
        #vendor-widget {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Header */
        .widget-header {
            background: #4573a8;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .widget-header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        /* Progress bar */
        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.3);
            margin-top: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            width: 25%;
            transition: width 0.3s;
        }
        
        /* Content area */
        .widget-content {
            padding: 30px;
            min-height: 400px;
        }
        
        /* Form groups */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: border-color 0.3s;
        }
        
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #4573a8;
        }
        
        /* Services section */
        .services-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            display: none;
        }
        
        .services-section.active {
            display: block;
        }
        
        .services-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        /* Service tags */
        .services-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .service-tag {
            display: inline-flex;
            align-items: center;
            padding: 10px 16px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }
        
        .service-tag:hover {
            border-color: #4573a8;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .service-tag.selected {
            background: #4573a8;
            color: white;
            border-color: #4573a8;
        }
        
        .service-badge {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        /* Navigation buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-prev {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-prev:hover {
            background: #e0e0e0;
        }
        
        .btn-next {
            background: #4573a8;
            color: white;
        }
        
        .btn-next:hover {
            background: #356090;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Modal for Level 3 services */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: #4573a8;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Messages */
        .message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.active {
            display: block;
        }
        
        .message.error {
            background: #fee;
            color: #c00;
            border: 1px solid #fcc;
        }
        
        .message.success {
            background: #efe;
            color: #060;
            border: 1px solid #cfc;
        }
    </style>
</head>
<body>
    <div id="vendor-widget">
        <div class="widget-header">
            <h1>Vendor Application</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
        </div>
        
        <div class="widget-content">
            <div id="message" class="message"></div>
            
            <!-- Step 1: Basic Information -->
            <div id="step-1" class="step active">
                <h2>Step 1: Basic Information</h2>
                
                <div class="form-group">
                    <label for="business_name">Business Name</label>
                    <input type="text" id="business_name" placeholder="Enter your business name">
                </div>
                
                <div class="form-group">
                    <label for="primary_category">Primary Service Category</label>
                    <select id="primary_category">
                        <option value="">Loading categories...</option>
                    </select>
                </div>
                
                <div id="primary_services" class="services-section">
                    <h3>Select Services You Offer:</h3>
                    <div class="services-container" id="primary_services_container">
                        <!-- Services will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="nav-buttons">
                <button class="btn btn-prev" id="btn-prev" onclick="previousStep()" disabled>Previous</button>
                <button class="btn btn-next" id="btn-next" onclick="nextStep()">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Level 3 Services -->
    <div id="level3-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Select Specific Services</h2>
                <button class="modal-close" onclick="closeLevel3Modal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Level 3 services will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-prev" onclick="closeLevel3Modal()">Cancel</button>
                <button class="btn btn-next" onclick="saveLevel3Selection()">Save Selection</button>
            </div>
        </div>
    </div>
    
    <script>
    // Global state
    let SERVICE_DATA = {};
    let currentStep = 1;
    let selectedServices = {
        primary: new Set(),
        level3: {}
    };
    
    // Clean up duplicate entries in Boat Maintenance
    const BOAT_MAINTENANCE_CLEAN = [
        "Ceramic Coating",
        "Boat Detailing",
        "Bottom Cleaning",
        "Bottom Painting",
        "Oil Change",
        "Bilge Cleaning",
        "Jet Ski Maintenance",
        "Barnacle Cleaning",
        "Fire and Safety Equipment",
        "Boat Wrapping",
        "Marine Protection Film",
        "Yacht Armor"
    ];
    
    // Initialize
    async function init() {
        console.log('Initializing vendor application...');
        await loadServiceData();
        setupEventHandlers();
    }
    
    // Load service data from API
    async function loadServiceData() {
        try {
            const response = await fetch('/api/v1/services/hierarchy');
            const data = await response.json();
            
            if (data.success && data.data) {
                SERVICE_DATA = data.data;
                
                // Clean up Boat Maintenance duplicates
                if (SERVICE_DATA['Boat Maintenance']) {
                    SERVICE_DATA['Boat Maintenance'].subcategories = BOAT_MAINTENANCE_CLEAN;
                }
                
                console.log('Loaded', Object.keys(SERVICE_DATA).length, 'categories');
                populateCategoryDropdown();
                return true;
            }
        } catch (error) {
            console.error('Failed to load service data:', error);
            showMessage('Error loading service categories. Please refresh the page.', 'error');
        }
        return false;
    }
    
    // Populate category dropdown
    function populateCategoryDropdown() {
        const dropdown = document.getElementById('primary_category');
        dropdown.innerHTML = '<option value="">Select a category...</option>';
        
        Object.keys(SERVICE_DATA).sort().forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            dropdown.appendChild(option);
        });
    }
    
    // Setup event handlers
    function setupEventHandlers() {
        // Category selection
        document.getElementById('primary_category').addEventListener('change', handleCategoryChange);
        
        // Service tag clicks (delegation)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('service-tag')) {
                handleServiceClick(e.target);
            }
        });
    }
    
    // Handle category selection
    function handleCategoryChange(e) {
        const category = e.target.value;
        const servicesSection = document.getElementById('primary_services');
        
        if (!category) {
            servicesSection.classList.remove('active');
            return;
        }
        
        const categoryData = SERVICE_DATA[category];
        if (!categoryData) {
            showMessage('No data found for this category', 'error');
            return;
        }
        
        renderServices(category, categoryData);
        servicesSection.classList.add('active');
    }
    
    // Render services
    function renderServices(category, categoryData) {
        const container = document.getElementById('primary_services_container');
        const subcategories = categoryData.subcategories || [];
        const level3Services = categoryData.level3Services || {};
        
        if (subcategories.length === 0) {
            container.innerHTML = '<p>No services available for this category.</p>';
            return;
        }
        
        container.innerHTML = subcategories.map(service => {
            const level3 = level3Services[service];
            const hasLevel3 = level3 && level3.length > 1;
            const badge = hasLevel3 ? `<span class="service-badge">${level3.length}</span>` : '';
            const selected = selectedServices.primary.has(service) ? 'selected' : '';
            
            return `<div class="service-tag ${selected}" 
                        data-service="${service}" 
                        data-category="${category}"
                        data-has-level3="${hasLevel3}">
                        ${service}${badge}
                    </div>`;
        }).join('');
    }
    
    // Handle service click
    function handleServiceClick(element) {
        const service = element.dataset.service;
        const category = element.dataset.category;
        const hasLevel3 = element.dataset.hasLevel3 === 'true';
        
        if (hasLevel3) {
            // Open Level 3 modal
            openLevel3Modal(category, service);
        } else {
            // Toggle selection
            element.classList.toggle('selected');
            if (element.classList.contains('selected')) {
                selectedServices.primary.add(service);
            } else {
                selectedServices.primary.delete(service);
            }
        }
    }
    
    // Open Level 3 modal
    function openLevel3Modal(category, service) {
        const modal = document.getElementById('level3-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        
        const categoryData = SERVICE_DATA[category];
        const level3Services = categoryData.level3Services[service] || [];
        
        modalTitle.textContent = `Select Specific ${service} Services`;
        
        // Store current context
        modal.dataset.category = category;
        modal.dataset.service = service;
        
        // Get currently selected services for this subcategory
        const selected = selectedServices.level3[service] || [];
        
        // Render Level 3 services
        modalBody.innerHTML = `
            <p>Select the specific services you offer:</p>
            <div class="services-container">
                ${level3Services.map(l3 => {
                    const isSelected = selected.includes(l3) ? 'selected' : '';
                    return `<div class="service-tag ${isSelected}" data-level3="${l3}">${l3}</div>`;
                }).join('')}
            </div>
        `;
        
        // Show modal
        modal.classList.add('active');
    }
    
    // Close Level 3 modal
    function closeLevel3Modal() {
        const modal = document.getElementById('level3-modal');
        modal.classList.remove('active');
    }
    
    // Save Level 3 selection
    function saveLevel3Selection() {
        const modal = document.getElementById('level3-modal');
        const service = modal.dataset.service;
        
        // Get selected Level 3 services
        const selected = [];
        modal.querySelectorAll('.service-tag.selected').forEach(tag => {
            selected.push(tag.dataset.level3);
        });
        
        if (selected.length > 0) {
            selectedServices.level3[service] = selected;
            selectedServices.primary.add(service);
            
            // Update the main service tag to show selected
            const mainTag = document.querySelector(`.service-tag[data-service="${service}"]`);
            if (mainTag) {
                mainTag.classList.add('selected');
            }
        } else {
            delete selectedServices.level3[service];
            selectedServices.primary.delete(service);
            
            // Update the main service tag
            const mainTag = document.querySelector(`.service-tag[data-service="${service}"]`);
            if (mainTag) {
                mainTag.classList.remove('selected');
            }
        }
        
        closeLevel3Modal();
    }
    
    // Navigation
    function nextStep() {
        // Validate current step
        if (currentStep === 1) {
            const businessName = document.getElementById('business_name').value;
            const category = document.getElementById('primary_category').value;
            
            if (!businessName) {
                showMessage('Please enter your business name', 'error');
                return;
            }
            
            if (!category) {
                showMessage('Please select a primary service category', 'error');
                return;
            }
            
            if (selectedServices.primary.size === 0) {
                showMessage('Please select at least one service', 'error');
                return;
            }
        }
        
        // For now, just show success
        showMessage('Form submitted successfully! (Additional steps would go here)', 'success');
        
        // Update progress
        updateProgress(50);
    }
    
    function previousStep() {
        // Would handle going back to previous steps
        updateProgress(25);
    }
    
    // Update progress bar
    function updateProgress(percent) {
        document.getElementById('progress').style.width = percent + '%';
    }
    
    // Show message
    function showMessage(text, type) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = 'message active ' + type;
        
        setTimeout(() => {
            messageEl.classList.remove('active');
        }, 5000);
    }
    
    // Handle Level 3 modal clicks
    document.getElementById('modal-body').addEventListener('click', function(e) {
        if (e.target.classList.contains('service-tag')) {
            e.target.classList.toggle('selected');
        }
    });
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    </script>
</body>
</html>