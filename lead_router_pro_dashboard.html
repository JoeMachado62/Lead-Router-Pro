<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocksidePros Lead Router - Enhanced Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .status-healthy { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        .status-warning { background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
        .status-error { background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); }
        
        /* Routing Slider Styles */
        .routing-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #3b82f6 0%, #3b82f6 var(--value), #e5e7eb var(--value), #e5e7eb 100%);
            outline: none;
            transition: background 0.3s;
        }
        .routing-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .routing-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .routing-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.info { background: #3b82f6; }
        
        /* User Guide Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .modal-body {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        .modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- User Guide Modal -->
    <div id="userGuideModal" class="modal-overlay" onclick="closeUserGuideModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Lead Router Pro - Admin User Guide</h2>
                <button class="modal-close" onclick="closeUserGuide()">✕</button>
            </div>
            <div class="modal-body">
                <iframe id="userGuideFrame" src="admin_user_guide.html"></iframe>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white/20 p-3 rounded-lg">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">DocksidePros Lead Router</h1>
                        <p class="text-blue-100">Enhanced Admin Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="systemStatus" class="px-4 py-2 rounded-full text-sm font-medium">
                        <span class="loading inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        Checking Status...
                    </div>
                    <button onclick="openUserGuide()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors" title="User Guide">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                    <button onclick="refreshDashboard()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors" title="Refresh">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500/30 p-2 rounded-lg transition-colors" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Active Forms</p>
                        <p id="formsCount" class="text-2xl font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Active Vendors</p>
                        <p id="vendorsCount" class="text-2xl font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Leads</p>
                        <p id="leadsCount" class="text-2xl font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Custom Fields</p>
                        <p id="fieldsCount" class="text-2xl font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="mb-8">
            <nav class="flex space-x-8">
                <button onclick="showTab('routing')" class="tab-button tab-active px-3 py-2 text-sm font-medium rounded-md">
                    Lead Routing
                </button>
                <button onclick="showTab('vendors')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    Vendor Management
                </button>
                <button onclick="showTab('configuration')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    System Configuration
                </button>
                <button onclick="showTab('fields')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    Field Management
                </button>
                <button onclick="showTab('monitoring')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    System Monitoring
                </button>
                <button onclick="showTab('admin')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    Admin Functions
                </button>
            </nav>
        </div>

        <!-- Lead Routing Tab -->
        <div id="routingTab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Routing Configuration Widget -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Lead Routing Distribution</h3>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-sm font-medium text-gray-700">Round Robin</span>
                                <span class="text-sm font-medium text-gray-700">Performance Based</span>
                            </div>
                            <div class="relative">
                                <input type="range" id="routingSlider" min="0" max="100" value="0" 
                                       class="routing-slider w-full" 
                                       oninput="updateRoutingDisplay(this.value)"
                                       onchange="saveRoutingConfiguration(this.value)">
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span id="roundRobinPercent" class="text-sm text-blue-600 font-medium">100%</span>
                                <span id="performancePercent" class="text-sm text-purple-600 font-medium">0%</span>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-2">Current Strategy</h4>
                            <p id="routingStrategy" class="text-sm text-gray-600">100% Round Robin - Fair distribution among all vendors</p>
                        </div>
                        
                        <div id="routingStats" class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Total Vendors:</span>
                                <span id="totalVendors" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Active & Taking Work:</span>
                                <span id="activeVendors" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Location Service:</span>
                                <span id="locationStatus" class="font-medium">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendor Matching Test - ENHANCED -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Test Vendor Matching</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code</label>
                            <input type="text" id="testZipCode" value="33139" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="5" placeholder="Enter 5-digit ZIP">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Primary Service Category</label>
                            <select id="testServiceCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateSpecificServices()">
                                <option value="">Select a category</option>
                            </select>
                        </div>
                        <div id="specificServiceDiv" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Specific Service Requested</label>
                            <select id="testSpecificService" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateAdditionalService()">
                                <option value="">Select specific service</option>
                            </select>
                        </div>
                        <div id="additionalServiceDiv" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Additional Details</label>
                            <select id="testAdditionalService" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select additional details</option>
                            </select>
                        </div>
                        <button onclick="testVendorMatching()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            Search for Vendors
                        </button>
                        <div id="matchingResults" class="bg-gray-50 rounded-lg p-4 min-h-[200px] overflow-auto border border-gray-200">
                            <p class="text-gray-500">Select service criteria and click 'Search for Vendors' to test coverage</p>
                        </div>
                    </div>
                </div>

                <!-- Process Unassigned Leads - NEW FUNCTIONALITY -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Process Unassigned Leads</h3>
                    <div class="space-y-4">
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-medium text-purple-900 mb-2">Bulk Lead Assignment</h4>
                            <p class="text-sm text-purple-700 mb-3">
                                Find unmatched leads in GoHighLevel and automatically assign them to available vendors using the enhanced routing system.
                            </p>
                            <div class="space-y-2 text-xs text-purple-600">
                                <div>• Searches for leads without assigned vendors</div>
                                <div>• Applies intelligent service category matching</div>
                                <div>• Uses dual routing algorithm for optimal assignment</div>
                                <div>• Updates both local database and GoHighLevel</div>
                            </div>
                        </div>
                        
                        <button onclick="processUnassignedLeads()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Process Unassigned Leads
                        </button>
                        
                        <div id="unassignedLeadsResult" class="bg-gray-800 text-white rounded-lg p-4 min-h-[160px] overflow-x-auto">
                            <p class="text-gray-400">Ready to process unassigned leads</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vendor Management Tab -->
        <div id="vendorsTab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Vendor Management</h3>
                    <button onclick="loadVendors()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        Refresh Vendors
                    </button>
                </div>
                <div id="vendorsList" class="overflow-x-auto">
                    <p class="text-gray-500">Loading vendors...</p>
                </div>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="configurationTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- API Configuration -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">GoHighLevel API Configuration</h3>
                    <form id="apiConfigForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location ID</label>
                            <input type="text" id="locationId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your GHL Location ID">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Private Integration Token</label>
                            <input type="password" id="privateToken" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="pit-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Agency API Key (Optional)</label>
                            <input type="password" id="agencyApiKey" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="For user creation features">
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="testGHLConnection()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                Test Connection
                            </button>
                            <button type="button" onclick="saveAPIConfig()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                Save Configuration
                            </button>
                        </div>
                    </form>
                    <div id="apiTestResult" class="mt-4"></div>
                </div>

                <!-- System Status -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">System Status</h3>
                    <div id="systemStatusDetails" class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600">Webhook System</span>
                            <span class="status-indicator">Checking...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600">Database Connection</span>
                            <span class="status-indicator">Checking...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600">Field Reference</span>
                            <span class="status-indicator">Checking...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600">Service Categories</span>
                            <span class="status-indicator">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fields Tab -->
        <div id="fieldsTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Field Management -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Custom Field Management</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-medium text-blue-900 mb-2">Generate Field Reference</h4>
                            <p class="text-sm text-blue-700 mb-3">Automatically scan your GHL location and generate field_reference.json</p>
                            <button onclick="generateFieldReference()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                Generate field_reference.json
                            </button>
                        </div>
                        
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h4 class="font-medium text-green-900 mb-2">Create Missing Fields</h4>
                            <p class="text-sm text-green-700 mb-3">Upload CSV file to automatically create missing custom fields</p>
                            <div class="space-y-2">
                                <input type="file" id="csvFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                <button onclick="createFieldsFromCSV()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
Create Fields from CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="fieldOperationResult" class="mt-4"></div>
                </div>

                <!-- Current Fields -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Custom Fields</h3>
                    <div id="currentFields" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Loading fields...</p>
                    </div>
                    <button onclick="loadCurrentFields()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                        Refresh Fields
                    </button>
                </div>
            </div>
        </div>

        <!-- Monitoring Tab -->
        <div id="monitoringTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Recent Activity -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                        <button onclick="loadRecentActivity()" class="text-sm text-blue-600 hover:underline">Refresh</button>
                    </div>
                    <div id="recentActivity" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Loading activity...</p>
                    </div>
                </div>

                <!-- Service Categories -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Active Service Categories</h3>
                    <div id="serviceCategories" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Loading categories...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Functions Tab -->
        <div id="adminTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Database Synchronization -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="bg-blue-100 p-2 rounded-lg">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Database Synchronization</h3>
                    </div>
                    <div class="space-y-4">
                        <div class="p-4 bg-yellow-50 border borde                                    r-yellow-200 rounded-lg">
                            <h4 class="font-medium text-yellow-900 mb-2">⚠️ Important Notice</h4>
                            <p class="text-sm text-yellow-800 mb-3">
                                This will validate all database records against GoHighLevel (GHL) as the single source of truth.
                                Records not found in GHL will be deleted from the database.
                            </p>
                        </div>
                        
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-medium text-blue-900 mb-2">Sync Process</h4>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>• Validates existing vendors and leads against GHL</li>
                                <li>• Updates records if data differs between database and GHL</li>
                                <li>• Removes orphaned records not found in GHL</li>
                                <li>• Adds new records from GHL to database</li>
                            </ul>
                        </div>
                        
                        <div id="syncStatus" class="hidden p-4 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div class="loading inline-block w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                                <span class="text-sm font-medium">Synchronizing database...</span>
                            </div>
                            <div id="syncProgress" class="mt-2 text-sm text-gray-600"></div>
                        </div>
                        
                        <div id="syncResults" class="hidden">
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h4 class="font-medium text-green-900 mb-2">✅ Sync Complete</h4>
                                <div id="syncDetails" class="text-sm text-green-800"></div>
                            </div>
                        </div>
                        
                        <button id="syncButton" onclick="synchronizeDatabase()" 
                                class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            🔄 Synchronize Database with GHL
                        </button>
                    </div>
                </div>
                
                <!-- Script Management -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="bg-purple-100 p-2 rounded-lg">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Script Management</h3>
                    </div>
                    <div class="space-y-4">
                        <p class="text-sm text-gray-600">
                            Manage and review administrative scripts and utilities.
                        </p>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h5 class="font-medium text-gray-900">GHL Truth Sync</h5>
                                        <p class="text-xs text-gray-600">sync_ghl_as_truth.py</p>
                                    </div>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Active</span>
                                </div>
                            </div>
                            
                            <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h5 class="font-medium text-gray-900">Legacy Vendor Sync</h5>
                                        <p class="text-xs text-gray-600">sync_vendors_from_ghl.py</p>
                                    </div>
                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Review</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="reviewScripts()" 
                                class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            📝 Review All Scripts
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'routing';
        const baseURL = window.location.origin;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            loadDashboardStats();
            loadRoutingConfiguration();
            loadCurrentFields();
            initializeServiceCategories(); // Initialize service categories for vendor matching
        });

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active', 'bg-blue-600', 'text-white');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('tab-active', 'bg-blue-600', 'text-white');
            event.target.classList.remove('text-gray-500', 'hover:text-gray-700');
            currentTab = tabName;
            
            if (tabName === 'routing') {
                loadRoutingConfiguration();
            } else if (tabName === 'vendors') {
                loadVendors();
            } else if (tabName === 'monitoring') {
                loadRecentActivity();
                loadServiceCategories();
            }
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Routing Configuration Functions
        async function loadRoutingConfiguration() {
            try {
                const response = await fetch(`${baseURL}/api/v1/routing/configuration`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const config = data.data.routing_configuration;
                    const performancePercent = config.performance_percentage || 0;
                    
                    // Update slider
                    const slider = document.getElementById('routingSlider');
                    slider.value = performancePercent;
                    updateRoutingDisplay(performancePercent);
                    
                    // Update stats
                    document.getElementById('totalVendors').textContent = data.data.total_vendors || 0;
                    document.getElementById('activeVendors').textContent = data.data.vendors_taking_work || 0;
                    document.getElementById('locationStatus').textContent = data.data.location_service_status || 'Unknown';
                }
            } catch (error) {
                console.error('Error loading routing configuration:', error);
            }
        }

        function updateRoutingDisplay(performancePercent) {
            const roundRobinPercent = 100 - performancePercent;
            
            document.getElementById('roundRobinPercent').textContent = roundRobinPercent + '%';
            document.getElementById('performancePercent').textContent = performancePercent + '%';
            
            // Update slider background
            const slider = document.getElementById('routingSlider');
            slider.style.setProperty('--value', performancePercent + '%');
            
            // Update strategy description
            let strategy = '';
            if (performancePercent === 0) {
                strategy = '100% Round Robin - Fair distribution among all vendors';
            } else if (performancePercent === 100) {
                strategy = '100% Performance Based - Routes to highest performing vendors';
            } else {
                strategy = `${roundRobinPercent}% Round Robin, ${performancePercent}% Performance Based - Hybrid approach`;
            }
            
            document.getElementById('routingStrategy').textContent = strategy;
        }

        async function saveRoutingConfiguration(performancePercent) {
            try {
                const response = await fetch(`${baseURL}/api/v1/routing/configuration`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        performance_percentage: parseInt(performancePercent)
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showNotification('Routing configuration saved successfully', 'success');
                } else {
                    showNotification('Failed to save routing configuration', 'error');
                }
            } catch (error) {
                console.error('Error saving routing configuration:', error);
                showNotification('Error saving routing configuration', 'error');
            }
        }

        // Service category data structure for vendor matching
        const serviceCategories = [
            "Boat and Yacht Repair",
            "Boat Charters and Rentals",
            "Boat Hauling and Yacht Delivery",
            "Boat Maintenance",
            "Boat Towing",
            "Boater Resources",
            "Buying or Selling a Boat",
            "Docks, Seawalls and Lifts",
            "Dock and Slip Rental",
            "Engines and Generators",
            "Fuel Delivery",
            "Marine Systems",
            "Maritime Education and Training",
            "Waterfront Property",
            "Wholesale or Dealer Product Pricing",
            "Yacht Management"
        ];

        // Service details mapping - matches comprehensive_service_mappings.py
        const serviceDetails = {
            "Boat Maintenance": [
                "Ceramic Coating", "Boat Detailing", "Bottom Cleaning", "Oil Change",
                "Bilge Cleaning", "Jet Ski Maintenance", "Barnacle Cleaning",
                "Fire Detection Systems", "Boat Wrapping or Marine Protection Film", "Other"
            ],
            "Boat and Yacht Repair": {
                "Main": ["Fiberglass Repair", "Welding & Metal Fabrication", "Carpentry & Woodwork",
                         "Teak or Woodwork", "Riggers & Masts", "Jet Ski Repair",
                         "Canvas or Upholstery", "Boat Decking", "Other"],
                "Fiberglass Repair": ["Hull Crack or Structural Repair", "Gelcoat Repair and Color Matching",
                               "Transom Repair & Reinforcement", "Deck Delamination & Soft Spot Repair",
                               "Stringer & Bulkhead Repair", "Other"],
                "Welding & Metal Fabrication": ["Aluminum or Stainless Steel Hull Repairs",
                                                 "Custom Railings, Ladders or Boarding Equipment",
                                                 "T-Tops, Hardtops or Bimini Frames",
                                                 "Fuel or Water Tank Fabrication",
                                                 "Exhaust, Engine Bed or Structural Reinforcement", "Other"],
                "Canvas or Upholstery": ["Upholstery", "Canvas or Sunshade", "Trim and Finish",
                                         "Boat Cover or T-Top", "Acrylic or Strataglass Enclosures", "Other"],
                "Boat Decking": ["SeaDek", "Real Teak Wood", "Cork", "Synthetic Teak",
                                 "Vinyl Flooring", "Tile Flooring", "Other"]
            },
            "Engines and Generators": {
                "Main": ["Outboard Engine Service", "Outboard Engine Sales", "Inboard Engine Service",
                         "Inboard Engine Sales", "Diesel Engine Service", "Diesel Engine Sales",
                         "Generator Service", "Generator Sales"],
                "Generator Service": ["Generator Installation", "Routine Generator Maintenance",
                                      "Electrical System Integration & Transfer Switches",
                                      "Diagnostics & Repairs", "Sound Shielding & Vibration Control"],
                "Outboard Engine Service": ["New Engine Sales", "Engine Refit", "Routine Engine Maintenance",
                                            "Cooling System Service", "Fuel System Cleaning & Repair",
                                            "Engine Diagnostics & Troubleshooting"]
            },
            "Marine Systems": {
                "Main": ["Stabilizers or Seakeepers", "Instrument Panel and Dashboard",
                         "AC Sales or Service", "Electrical Service", "Sound System",
                         "Plumbing", "Lighting", "Refrigeration or Watermakers"],
                "AC Sales or Service": ["New AC Install or Replacement", "AC Maintenance & Servicing",
                                        "Refrigerant Charging & Leak Repair", "Pump & Water Flow Troubleshooting",
                                        "Thermostat & Control Panel Upgrades"],
                "Electrical Service": ["Battery System Install or Maintenance", "Wiring & Rewiring",
                                       "Shore Power & Inverter Systems", "Lighting Systems",
                                       "Electrical Panel & Breaker", "Navigation & Communication",
                                       "Generator Electrical Integration", "Solar Power & Battery Charging"]
            },
            "Boat Charters and Rentals": {
                "Main": ["Weekly or Monthly Yacht or Catamaran Charter", "Daily Yacht or Catamaran Charter",
                         "Sailboat Charter", "Fishing Charter", "Party Boat Charter", "Pontoon Charter",
                         "Jet Ski Rental", "Paddleboard Rental", "Kayak Rental",
                         "eFoil, Kiteboarding or Wing Surfing Lessons", "Boat Club"],
                "Fishing Charter": ["Inshore Fishing Charter", "Offshore (Deep Sea) Fishing Charter",
                                   "Reef & Wreck Fishing Charter", "Drift Boat Charter",
                                   "Freshwater Fishing Charter", "Private Party Boat Charter"]
            },
            "Docks, Seawalls and Lifts": {
                "Main": ["Dock and Seawall Builders or Repair", "Boat Lift Installers",
                         "Floating Dock Sales", "Davit and Hydraulic Platform"],
                "Dock and Seawall Builders or Repair": ["Seawall Construction or Repair", "New Dock",
                                                        "Dock Repair", "Pilings or Structural Support",
                                                        "Floating Docks", "Boat Lift", "Seawall or Piling Cleaning"]
            },
            "Boat Towing": ["Get Emergency Tow", "Get Towing Membership"],
            "Fuel Delivery": ["Dyed Diesel Fuel (For Boats)", "Regular Diesel Fuel (Landside Business)",
                             "Rec 90 (Ethanol Free Gas)"],
            "Dock and Slip Rental": ["Private Dock", "Boat Slip", "Marina", "Mooring Ball"],
            "Yacht Management": ["Full Service Vessel Management", "Technical Management",
                                "Crew Management", "Accounting & Financial Management",
                                "Insurance & Risk Management", "Regulatory Compliance"],
            "Boater Resources": ["Boat or Yacht Parts", "Vessel WiFi or Communications", "Provisioning",
                                "Boat Salvage", "Photography or Videography", "Crew Management",
                                "Account Management and Bookkeeping", "Marketing or Web Design"],
            "Buying or Selling a Boat": ["Boat Insurance", "Yacht Insurance", "Yacht Broker",
                                         "Boat Broker", "Boat Financing", "Boat Surveyors",
                                         "Yacht Dealers", "Boat Dealers"],
            "Maritime Education and Training": ["Yacht, Sailboat or Catamaran On Water Training",
                                               "Interested In Buying a Boat/Insurance Signoff",
                                               "Maritime Academy", "Sailing Schools", "Captains License"],
            "Waterfront Property": ["Buy a Waterfront Home or Condo", "Sell a Waterfront Home or Condo",
                                   "Buy a Waterfront New Development", "Rent a Waterfront Property"],
            "Wholesale or Dealer Product Pricing": ["Apparel", "Boat Accessories",
                                                   "Boat Maintenance & Cleaning Products",
                                                   "Boat Safety Products", "Diving Equipment",
                                                   "Dock Accessories", "Fishing Gear",
                                                   "Personal Watercraft", "Other"]
        };

        // Initialize service categories dropdown
        function initializeServiceCategories() {
            const categorySelect = document.getElementById('testServiceCategory');
            if (!categorySelect) return;
            
            categorySelect.innerHTML = '<option value="">Select a category</option>';
            serviceCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        // Update specific services based on selected category
        function updateSpecificServices() {
            const category = document.getElementById('testServiceCategory').value;
            const specificDiv = document.getElementById('specificServiceDiv');
            const specificSelect = document.getElementById('testSpecificService');
            const additionalDiv = document.getElementById('additionalServiceDiv');
            
            // Hide additional service dropdown
            additionalDiv.style.display = 'none';
            
            if (!category) {
                specificDiv.style.display = 'none';
                return;
            }
            
            const services = serviceDetails[category];
            if (!services) {
                specificDiv.style.display = 'none';
                return;
            }
            
            specificDiv.style.display = 'block';
            specificSelect.innerHTML = '<option value="">Select specific service (optional)</option>';
            
            if (Array.isArray(services)) {
                // Simple list of services
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service;
                    option.textContent = service;
                    specificSelect.appendChild(option);
                });
            } else if (services.Main) {
                // Category has subcategories
                services.Main.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service;
                    option.textContent = service;
                    specificSelect.appendChild(option);
                });
            }
        }

        // Update additional service dropdown for third-level options
        function updateAdditionalService() {
            const category = document.getElementById('testServiceCategory').value;
            const specificService = document.getElementById('testSpecificService').value;
            const additionalDiv = document.getElementById('additionalServiceDiv');
            const additionalSelect = document.getElementById('testAdditionalService');
            
            if (!category || !specificService) {
                additionalDiv.style.display = 'none';
                return;
            }
            
            const services = serviceDetails[category];
            
            // Check if this specific service has additional options
            if (typeof services === 'object' && !Array.isArray(services) && services[specificService]) {
                const additionalOptions = services[specificService];
                
                additionalDiv.style.display = 'block';
                additionalSelect.innerHTML = '<option value="">Select additional details (optional)</option>';
                
                additionalOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    additionalSelect.appendChild(optionElement);
                });
            } else {
                additionalDiv.style.display = 'none';
            }
        }

        // Enhanced vendor matching test function
        async function testVendorMatching() {
            const zipCode = document.getElementById('testZipCode').value;
            const serviceCategory = document.getElementById('testServiceCategory').value;
            const specificService = document.getElementById('testSpecificService').value;
            const additionalService = document.getElementById('testAdditionalService').value;
            
            // Validate inputs
            if (!zipCode || zipCode.length !== 5) {
                showNotification('Please enter a valid 5-digit ZIP code', 'error');
                return;
            }
            
            if (!serviceCategory) {
                showNotification('Please select a service category', 'error');
                return;
            }
            
            const resultsDiv = document.getElementById('matchingResults');
            resultsDiv.innerHTML = '<p class="text-gray-500">Searching for vendors...</p>';
            
            try {
                // Use enhanced endpoint
                const response = await fetch(`${baseURL}/api/v1/vendor-matching/test-vendor-matching`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        zip_code: zipCode,
                        service_category: serviceCategory,
                        specific_service: specificService || null,
                        additional_service: additionalService || null
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    let html = '<div class="space-y-3">';
                    
                    // Display search criteria
                    html += '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3">';
                    html += '<h4 class="font-semibold text-blue-900 mb-2">Search Criteria:</h4>';
                    html += `<p class="text-sm text-blue-700">ZIP Code: ${zipCode}</p>`;
                    html += `<p class="text-sm text-blue-700">Category: ${serviceCategory}</p>`;
                    if (specificService) {
                        html += `<p class="text-sm text-blue-700">Service: ${specificService}</p>`;
                    }
                    if (additionalService) {
                        html += `<p class="text-sm text-blue-700">Details: ${additionalService}</p>`;
                    }
                    html += '</div>';
                    
                    // Display vendor results
                    if (result.vendors && result.vendors.length > 0) {
                        html += '<div class="bg-green-50 border border-green-200 rounded-lg p-3">';
                        html += `<h4 class="font-semibold text-green-900 mb-2">✅ Found ${result.vendors.length} Vendor(s)</h4>`;
                        html += '</div>';
                        
                        // List all vendors
                        result.vendors.forEach((vendor, index) => {
                            html += '<div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">';
                            html += `<div class="flex justify-between items-start mb-3">`;
                            html += `<h5 class="font-semibold text-gray-900 text-lg">${index + 1}. ${vendor.company_name}</h5>`;
                            if (vendor.priority_score) {
                                html += `<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">Priority: ${vendor.priority_score}</span>`;
                            }
                            html += '</div>';
                            
                            // Contact info stacked vertically for better readability
                            html += '<div class="space-y-2">';
                            html += `<div class="text-sm"><span class="text-gray-600 font-medium">📞 Phone:</span> <a href="tel:${vendor.phone}" class="text-blue-600 hover:underline ml-1">${vendor.phone}</a></div>`;
                            html += `<div class="text-sm"><span class="text-gray-600 font-medium">📧 Email:</span> <a href="mailto:${vendor.email}" class="text-blue-600 hover:underline ml-1">${vendor.email}</a></div>`;
                            html += '</div>';
                            
                            // Additional info in a horizontal layout if present
                            if (vendor.hourly_rate || vendor.lead_count !== undefined) {
                                html += '<div class="flex gap-4 mt-3 text-sm">';
                                if (vendor.hourly_rate) {
                                    html += `<div><span class="text-gray-600">💰 Rate:</span> <span class="font-medium">$${vendor.hourly_rate}/hr</span></div>`;
                                }
                                if (vendor.lead_count !== undefined) {
                                    html += `<div><span class="text-gray-600">📊 Leads:</span> <span class="font-medium">${vendor.lead_count}</span></div>`;
                                }
                                html += '</div>';
                            }
                            
                            if (vendor.coverage_areas) {
                                html += `<div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500">📍 Coverage: ${vendor.coverage_areas}</div>`;
                            }
                            
                            html += '</div>';
                        });
                    } else {
                        html += '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">';
                        html += '<h4 class="font-semibold text-yellow-900 mb-2">⚠️ No Vendors Found</h4>';
                        html += '<p class="text-sm text-yellow-700">No vendors are currently available for this service in ZIP code ' + zipCode + '</p>';
                        html += '<p class="text-sm text-yellow-700 mt-2">Suggestions:</p>';
                        html += '<ul class="list-disc list-inside text-sm text-yellow-700 mt-1">';
                        html += '<li>Try a nearby ZIP code</li>';
                        html += '<li>Select a broader service category</li>';
                        html += '<li>Contact admin to add vendors for this area</li>';
                        html += '</ul>';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                } else if (result.status === 'error') {
                    resultsDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-900 mb-2">❌ Error</h4>
                        <p class="text-sm text-red-700">${result.message || 'Failed to search for vendors'}</p>
                    </div>`;
                } else {
                    resultsDiv.innerHTML = `<div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <p class="text-sm text-gray-700">Unexpected response. Please try again.</p>
                    </div>`;
                }
            } catch (error) {
                console.error('Error testing vendor matching:', error);
                resultsDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h4 class="font-semibold text-red-900 mb-2">❌ Network Error</h4>
                    <p class="text-sm text-red-700">${error.message}</p>
                </div>`;
            }
        }

        // NEW: Process Unassigned Leads Functionality
        async function processUnassignedLeads() {
            const resultElement = document.getElementById('unassignedLeadsResult');
            
            // Show loading state
            resultElement.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div>
                    <span class="ml-3 text-purple-300">Processing unassigned leads...</span>
                </div>
            `;
            
            try {
                const response = await fetch(`${baseURL}/api/v1/routing/process-unassigned-leads`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const successMessage = `✅ Successfully processed ${data.data.processed_leads} leads
✅ Successful assignments: ${data.data.successful_assignments}
❌ Failed assignments: ${data.data.failed_assignments}

📊 Processing Details:
${data.data.leads.map((lead, index) => 
    `${index + 1}. ${lead.customer_name} (${lead.service_category})
   ${lead.assignment_successful ? '✅ Assigned to: ' + (lead.assigned_vendor?.name || 'Unknown') : '❌ Failed: ' + (lead.error_message || 'Unknown error')}`
).join('\n')}`;

                    resultElement.innerHTML = `<pre class="text-green-300 text-sm">${successMessage}</pre>`;
                    showNotification(`Processed ${data.data.processed_leads} leads: ${data.data.successful_assignments} assigned`, 'success');
                } else {
                    resultElement.innerHTML = `<pre class="text-red-300 text-sm">❌ Error: ${data.message}</pre>`;
                    showNotification('Failed to process unassigned leads', 'error');
                }
            } catch (error) {
                console.error('Error processing unassigned leads:', error);
                resultElement.innerHTML = `<pre class="text-red-300 text-sm">❌ Network Error: ${error.message}</pre>`;
                showNotification('Error processing unassigned leads: ' + error.message, 'error');
            }
        }

        // Original Dashboard Functions
        async function checkSystemStatus() {
            try {
                showSystemStatusMessage('🔍 Running comprehensive system health check...', 'info');
                const response = await fetch(`${baseURL}/api/v1/webhooks/health`);
                const data = await response.json();
                updateSystemStatus(data);
                updateSystemStatusDetails(data);
                if (data.status === 'healthy') {
                    showSystemStatusMessage('✅ System health check completed successfully! All components operational.', 'success');
                } else {
                    showSystemStatusMessage('⚠️ System health check completed with warnings. Some components need attention.', 'warning');
                }
            } catch (error) {
                updateSystemStatus({ status: 'error', message: 'Connection failed' });
                showSystemStatusMessage('❌ System health check failed: ' + error.message, 'error');
            }
        }

        function updateSystemStatus(data) {
            const statusEl = document.getElementById('systemStatus');
            statusEl.innerHTML = '';
            if (data.status === 'healthy') {
                statusEl.className = 'px-4 py-2 rounded-full text-sm font-medium status-healthy text-white';
                statusEl.innerHTML = '✅ System Healthy';
            } else if (data.status === 'degraded') {
                statusEl.className = 'px-4 py-2 rounded-full text-sm font-medium status-warning text-white';
                statusEl.innerHTML = '⚠️ System Degraded';
            } else {
                statusEl.className = 'px-4 py-2 rounded-full text-sm font-medium status-error text-white';
                statusEl.innerHTML = '❌ System Error';
            }
        }

        function updateSystemStatusDetails(data) {
            const indicators = document.querySelectorAll('.status-indicator');
            const statuses = [
                (data.webhook_system === 'enhanced_dynamic_processing' || data.webhook_system === 'clean_direct_processing_no_ai') ? 'healthy' : 'error',
                data.database_status === 'healthy' ? 'healthy' : 'error',
                data.field_reference_status === 'loaded' ? 'healthy' : 'error',
                data.service_categories > 15 ? 'healthy' : 'warning'
            ];
            indicators.forEach((indicator, index) => {
                const status = statuses[index];
                if (status === 'healthy') indicator.innerHTML = '<span class="text-green-600 font-medium">✅ Healthy</span>';
                else if (status === 'warning') indicator.innerHTML = '<span class="text-yellow-600 font-medium">⚠️ Warning</span>';
                else indicator.innerHTML = '<span class="text-red-600 font-medium">❌ Error</span>';
            });
        }

        function showSystemStatusMessage(message, type) {
            let messageEl = document.getElementById('systemStatusMessage');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'systemStatusMessage';
                messageEl.className = 'mt-4 p-3 rounded-lg text-sm';
                document.querySelector('#systemStatusDetails').appendChild(messageEl);
            }
            const colors = {
                success: 'bg-green-50 border border-green-200 text-green-800',
                error: 'bg-red-50 border border-red-200 text-red-800',
                warning: 'bg-yellow-50 border border-yellow-200 text-yellow-800',
                info: 'bg-blue-50 border border-blue-200 text-blue-800'
            };
            messageEl.className = `mt-4 p-3 rounded-lg text-sm ${colors[type]}`;
            messageEl.textContent = message;
            if (type === 'info') setTimeout(() => { if (messageEl) messageEl.remove(); }, 5000);
        }

        async function loadDashboardStats() {
            try {
                const [healthResponse, categoriesResponse, statsResponse] = await Promise.all([
                    fetch(`${baseURL}/api/v1/webhooks/health`),
                    fetch(`${baseURL}/api/v1/webhooks/service-categories`),
                    fetch(`${baseURL}/api/v1/simple-admin/stats`)
                ]);
                const healthData = await healthResponse.json();
                const categoriesData = await categoriesResponse.json();
                const statsData = await statsResponse.json();
                document.getElementById('formsCount').textContent = categoriesData.total_categories || 17;
                document.getElementById('fieldsCount').textContent = healthData.custom_field_mappings || 0;
                if (statsData.status === 'success') {
                    document.getElementById('vendorsCount').textContent = statsData.data.vendors || 0;
                    document.getElementById('leadsCount').textContent = statsData.data.leads || 0;
                }
            } catch (error) { 
                console.error('Error loading stats:', error); 
            }
        }

        async function testGHLConnection() {
            const locationId = document.getElementById('locationId').value;
            const privateToken = document.getElementById('privateToken').value;
            if (!locationId || !privateToken) {
                showResult('apiTestResult', 'error', 'Please fill in Location ID and Private Token');
                return;
            }
            showResult('apiTestResult', 'info', 'Testing connection...');
            try {
                const response = await fetch(`${baseURL}/api/v1/admin/test-ghl-connection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locationId, privateToken })
                });
                const data = await response.json();
                if (data.success) {
                    showResult('apiTestResult', 'success', 'Connection successful! Found ' + (data.fieldCount || 0) + ' custom fields.');
                } else {
                    showResult('apiTestResult', 'error', 'Connection failed: ' + data.error);
                }
            } catch (error) { 
                showResult('apiTestResult', 'error', 'Connection test failed: ' + error.message); 
            }
        }

        async function generateFieldReference() {
            showResult('fieldOperationResult', 'info', 'Generating field reference...');
            try {
                const response = await fetch(`${baseURL}/api/v1/admin/generate-field-reference`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showResult('fieldOperationResult', 'success', `Successfully generated field_reference.json with ${data.fieldCount} fields.`);
                    loadCurrentFields();
                } else {
                    showResult('fieldOperationResult', 'error', 'Failed to generate field reference: ' + data.detail);
                }
            } catch (error) { 
                showResult('fieldOperationResult', 'error', 'Error generating field reference: ' + error.message); 
            }
        }
        
        async function loadRecentActivity() {
            try {
                const response = await fetch(`${baseURL}/api/v1/admin/recent-activity`);
                const data = await response.json();
                const activityContainer = document.getElementById('recentActivity');
                if (data.success && data.activities && data.activities.length > 0) {
                    let activityHTML = '';
                    data.activities.forEach(activity => {
                        const timeAgo = new Date(activity.timestamp).toLocaleString();
                        const statusColor = activity.success ? 'text-green-600' : 'text-red-600';
                        activityHTML += `
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-gray-900">${activity.event_type.replace(/_/g, ' ')}</span>
                                    <span class="text-xs text-gray-500">${timeAgo}</span>
                                </div>
                                <div class="text-sm ${statusColor} mt-1">
                                    ${activity.success ? '✅ Success' : `❌ ${activity.error_message || 'Failed'}`}
                                </div>
                            </div>`;
                    });
                    activityContainer.innerHTML = activityHTML;
                } else {
                    activityContainer.innerHTML = '<p class="text-gray-500">No recent activity found.</p>';
                }
            } catch (error) { 
                document.getElementById('recentActivity').innerHTML = '<p class="text-red-500">Error loading activity.</p>'; 
            }
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            const colors = {
                success: 'bg-green-900/50 border-green-500 text-green-200',
                error: 'bg-red-900/50 border-red-500 text-red-200',
                info: 'bg-blue-900/50 border-blue-500 text-blue-200'
            };
            element.innerHTML = `
                <div class="p-4 border rounded-lg ${colors[type] || colors['info']}">
                    <pre class="whitespace-pre-wrap text-sm font-mono">${message}</pre>
                </div>`;
        }
        
        async function createFieldsFromCSV() {
            const fileInput = document.getElementById("csvFile");
            const file = fileInput.files[0];
            
            if (!file) {
                showResult("fieldOperationResult", "error", "Please select a CSV file");
                return;
            }
            
            showResult("fieldOperationResult", "info", "Creating fields from CSV...");
            
            const formData = new FormData();
            formData.append("csvFile", file);
            
            try {
                const response = await fetch(`${baseURL}/api/v1/admin/create-fields-from-csv`, {
                    method: "POST",
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult("fieldOperationResult", "success", 
                        `Successfully processed CSV. Created: ${data.created}, Skipped: ${data.skipped}, Errors: ${data.errors}`);
                    loadCurrentFields();
                } else {
                    showResult("fieldOperationResult", "error", "Failed to process CSV: " + data.detail);
                }
            } catch (error) {
                showResult("fieldOperationResult", "error", "Error processing CSV: " + error.message);
            }
        }

        async function loadCurrentFields() {
            try {
                const response = await fetch(`${baseURL}/api/v1/webhooks/field-mappings`);
                const data = await response.json();
                const fieldsContainer = document.getElementById("currentFields");
                
                if (data.status === "success") {
                    const fields = data.custom_field_mappings;
                    let fieldsHTML = "";
                    
                    Object.entries(fields).forEach(([fieldKey, fieldData]) => {
                        const dataType = fieldData.dataType || "TEXT";
                        const typeColors = {
                            TEXT: "bg-blue-100 text-blue-800",
                            LARGE_TEXT: "bg-purple-100 text-purple-800",
                            NUMERICAL: "bg-green-100 text-green-800",
                            DATE: "bg-yellow-100 text-yellow-800",
                            RADIO: "bg-pink-100 text-pink-800"
                        };
                        const colorClass = typeColors[dataType] || "bg-gray-100 text-gray-800";
                        
                        fieldsHTML += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <span class="font-medium text-gray-900">${fieldData.name}</span>
                                    <span class="text-xs text-gray-500 ml-2">${fieldKey}</span>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${colorClass}">
                                    ${dataType}
                                </span>
                            </div>
                        `;
                    });
                    
                    fieldsContainer.innerHTML = fieldsHTML || '<p class="text-gray-500">No custom fields found</p>';
                } else {
                    fieldsContainer.innerHTML = '<p class="text-red-500">Error loading fields</p>';
                }
            } catch (error) {
                document.getElementById("currentFields").innerHTML = '<p class="text-red-500">Error loading fields</p>';
            }
        }

        async function loadServiceCategories() {
            try {
                const response = await fetch(`${baseURL}/api/v1/webhooks/service-categories`);
                const data = await response.json();
                const categoriesContainer = document.getElementById("serviceCategories");
                
                if (data.status === "success") {
                    let categoriesHTML = "";
                    
                    Object.entries(data.service_categories).forEach(([categoryName, formIdentifiers]) => {
                        // categoryName is the category like "Engines and Generators"
                        // formIdentifiers is an array of form IDs like ["engines_generators", "outboard_engine_service", ...]
                        const serviceCount = Array.isArray(formIdentifiers) ? formIdentifiers.length : 0;
                        categoriesHTML += `
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="font-medium text-gray-900">${categoryName}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    ${serviceCount} service${serviceCount !== 1 ? 's' : ''} available
                                </div>
                            </div>
                        `;
                    });
                    
                    categoriesContainer.innerHTML = categoriesHTML;
                } else {
                    categoriesContainer.innerHTML = '<p class="text-red-500">Error loading categories</p>';
                }
            } catch (error) {
                document.getElementById("serviceCategories").innerHTML = '<p class="text-red-500">Error loading categories</p>';
            }
        }

        async function loadVendors() {
            try {
                const response = await fetch(`${baseURL}/api/v1/simple-admin/vendors`);
                const data = await response.json();
                const vendorsContainer = document.getElementById("vendorsList");
                
                if (data.status === "success" && data.data.length > 0) {
                    let vendorsHTML = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taking Work</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    
                    data.data.forEach(vendor => {
                        const statusColors = {
                            active: "bg-green-100 text-green-800",
                            pending: "bg-yellow-100 text-yellow-800",
                            inactive: "bg-red-100 text-red-800"
                        };
                        const statusClass = statusColors[vendor.status] || "bg-gray-100 text-gray-800";
                        
                        const performancePercent = vendor.performance_score 
                            ? (vendor.performance_score * 100).toFixed(0) 
                            : vendor.lead_close_percentage || 0;
                        
                        vendorsHTML += `
                            <tr id="vendor-row-${vendor.id}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">${vendor.name}</div>
                                        <div class="text-sm text-gray-500">${vendor.email}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${vendor.company_name || "Not specified"}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                        ${vendor.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${performancePercent}%
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <label class="flex items-center cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            ${vendor.taking_new_work ? 'checked' : ''} 
                                            onchange="toggleVendorWork('${vendor.id}', this.checked)"
                                            class="form-checkbox h-4 w-4 text-blue-600"
                                        />
                                        <span class="ml-2 text-sm vendor-status-text ${vendor.taking_new_work ? 'text-green-600' : 'text-red-600'}">
                                            ${vendor.taking_new_work ? 'Yes' : 'No'}
                                        </span>
                                    </label>
                                </td>
                            </tr>
                        `;
                    });
                    
                    vendorsHTML += "</tbody></table>";
                    vendorsContainer.innerHTML = vendorsHTML;
                } else {
                    vendorsContainer.innerHTML = '<p class="text-gray-500">No vendors found</p>';
                }
            } catch (error) {
                document.getElementById("vendorsList").innerHTML = '<p class="text-red-500">Error loading vendors</p>';
                console.error('Error loading vendors:', error);
            }
        }

        async function toggleVendorWork(vendorId, isChecked) {
            try {
                const response = await fetch(`${baseURL}/api/v1/vendor-toggle/availability`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vendor_id: vendorId,
                        taking_new_work: isChecked
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Update UI immediately
                    const row = document.getElementById(`vendor-row-${vendorId}`);
                    const span = row.querySelector('.vendor-status-text');
                    span.textContent = isChecked ? 'Yes' : 'No';
                    span.className = `ml-2 text-sm vendor-status-text ${isChecked ? 'text-green-600' : 'text-red-600'}`;
                    
                    showNotification(`Vendor availability updated successfully`, 'success');
                } else {
                    // Revert checkbox
                    const checkbox = document.querySelector(`input[onchange*="${vendorId}"]`);
                    checkbox.checked = !isChecked;
                    showNotification('Failed to update vendor', 'error');
                }
                
            } catch (error) {
                // Revert checkbox
                const checkbox = document.querySelector(`input[onchange*="${vendorId}"]`);
                checkbox.checked = !isChecked;
                showNotification('Error updating vendor', 'error');
                console.error('Error:', error);
            }
        }

        function refreshDashboard() {
            checkSystemStatus();
            loadDashboardStats();
            
            if (currentTab === 'fields') {
                loadCurrentFields();
            } else if (currentTab === 'monitoring') {
                loadRecentActivity();
                loadServiceCategories();
            } else if (currentTab === 'vendors') {
                loadVendors();
            } else if (currentTab === 'routing') {
                loadRoutingConfiguration();
            }
        }

        // Admin Functions
        async function synchronizeDatabase() {
            const syncButton = document.getElementById('syncButton');
            const syncStatus = document.getElementById('syncStatus');
            const syncResults = document.getElementById('syncResults');
            const syncProgress = document.getElementById('syncProgress');
            const syncDetails = document.getElementById('syncDetails');
            
            // Show loading state
            syncButton.disabled = true;
            syncButton.innerHTML = '⏳ Synchronizing...';
            syncStatus.classList.remove('hidden');
            syncStatus.className = 'p-4 bg-blue-50 border border-blue-200 rounded-lg';
            syncResults.classList.add('hidden');
            
            try {
                syncProgress.textContent = 'Starting synchronization process...';
                
                // Try the request with a retry for 404 errors (proxy/routing delays)
                let response;
                let retryCount = 0;
                const maxRetries = 2;
                
                while (retryCount <= maxRetries) {
                    response = await fetch(`${baseURL}/api/v1/admin/sync-database`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.status === 404 && retryCount < maxRetries) {
                        retryCount++;
                        syncProgress.textContent = `Route not ready, retrying (${retryCount}/${maxRetries})...`;
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                        continue;
                    }
                    break;
                }
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Sync endpoint not found. Please refresh the page and try again.');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Hide loading state
                syncStatus.classList.add('hidden');
                
                // Show results
                if (result.status === 'success') {
                    syncResults.classList.remove('hidden');
                    syncDetails.innerHTML = `
                        <div class="space-y-2">
                            <div><strong>Vendors:</strong> ${result.vendors.updated} updated, ${result.vendors.deleted} deleted, ${result.vendors.added} added</div>
                            <div><strong>Leads:</strong> ${result.leads.updated} updated, ${result.leads.deleted} deleted, ${result.leads.added} added</div>
                            <div class="mt-2 text-xs text-green-700">${result.message}</div>
                        </div>
                    `;
                    showNotification('Database synchronized successfully!', 'success');
                } else {
                    throw new Error(result.message || 'Sync failed');
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                syncStatus.classList.add('hidden');
                
                // Show error state
                syncResults.classList.remove('hidden');
                syncResults.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <h4 class="font-medium text-red-900 mb-2">❌ Sync Failed</h4>
                        <div class="text-sm text-red-800">${error.message}</div>
                    </div>
                `;
                showNotification('Database synchronization failed', 'error');
            } finally {
                // Reset button
                syncButton.disabled = false;
                syncButton.innerHTML = '🔄 Synchronize Database with GHL';
            }
        }
        
        async function reviewScripts() {
            showNotification('Script review functionality coming soon', 'info');
            // TODO: Implement script review modal showing all scripts with their status
        }

        // Placeholder functions for API config
        function saveAPIConfig() {
            showNotification('API configuration save functionality coming soon', 'info');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = '/login';
            }
        }
        
        // User Guide Modal Functions
        function openUserGuide() {
            const modal = document.getElementById('userGuideModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeUserGuide() {
            const modal = document.getElementById('userGuideModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        
        function closeUserGuideModal(event) {
            // Close modal when clicking on overlay (not the content)
            if (event.target === event.currentTarget) {
                closeUserGuide();
            }
        }
        
        // Keyboard shortcut for User Guide (? key)
        document.addEventListener('keydown', function(e) {
            // Check if ? key is pressed (Shift + /)
            if (e.shiftKey && e.key === '?') {
                e.preventDefault();
                openUserGuide();
            }
            // Close modal with Escape key
            if (e.key === 'Escape') {
                const modal = document.getElementById('userGuideModal');
                if (modal.classList.contains('active')) {
                    closeUserGuide();
                }
            }
        });
    </script>
</body>
</html>