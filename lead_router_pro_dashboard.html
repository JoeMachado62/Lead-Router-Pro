<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocksidePros Lead Router - Enhanced Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .status-healthy { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        .status-warning { background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
        .status-error { background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); }
        
        /* Routing Slider Styles */
        .routing-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #3b82f6 0%, #3b82f6 var(--value), #e5e7eb var(--value), #e5e7eb 100%);
            outline: none;
            transition: background 0.3s;
        }
        .routing-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .routing-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .routing-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.info { background: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white/20 p-3 rounded-lg">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">DocksidePros Lead Router</h1>
                        <p class="text-blue-100">Enhanced Admin Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="systemStatus" class="px-4 py-2 rounded-full text-sm font-medium">
                        <span class="loading inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        Checking Status...
                    </div>
                    <button onclick="refreshDashboard()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors" title="Refresh">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500/30 p-2 rounded-lg transition-colors" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Active Forms</p>
                        <p id="formsCount" class="text-2xl font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Active Vendors</p>
                        <p id="vendorsCount" class="text-2xl font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Leads</p>
                        <p id="leadsCount" class="text-2xl font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Custom Fields</p>
                        <p id="fieldsCount" class="text-2xl font-bold text-gray-900">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="mb-8">
            <nav class="flex space-x-8">
                <button onclick="showTab('routing')" class="tab-button tab-active px-3 py-2 text-sm font-medium rounded-md">
                    Lead Routing
                </button>
                <button onclick="showTab('vendors')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    Vendor Management
                </button>
                <button onclick="showTab('configuration')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    System Configuration
                </button>
                <button onclick="showTab('fields')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    Field Management
                </button>
                <button onclick="showTab('monitoring')" class="tab-button px-3 py-2 text-sm font-medium rounded-md">
                    System Monitoring
                </button>
            </nav>
        </div>

        <!-- Lead Routing Tab -->
        <div id="routingTab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Routing Configuration Widget -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Lead Routing Distribution</h3>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-sm font-medium text-gray-700">Round Robin</span>
                                <span class="text-sm font-medium text-gray-700">Performance Based</span>
                            </div>
                            <div class="relative">
                                <input type="range" id="routingSlider" min="0" max="100" value="0" 
                                       class="routing-slider w-full" 
                                       oninput="updateRoutingDisplay(this.value)"
                                       onchange="saveRoutingConfiguration(this.value)">
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span id="roundRobinPercent" class="text-sm text-blue-600 font-medium">100%</span>
                                <span id="performancePercent" class="text-sm text-purple-600 font-medium">0%</span>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-2">Current Strategy</h4>
                            <p id="routingStrategy" class="text-sm text-gray-600">100% Round Robin - Fair distribution among all vendors</p>
                        </div>
                        
                        <div id="routingStats" class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Total Vendors:</span>
                                <span id="totalVendors" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Active & Taking Work:</span>
                                <span id="activeVendors" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Location Service:</span>
                                <span id="locationStatus" class="font-medium">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendor Matching Test -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Test Vendor Matching</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code</label>
                            <input type="text" id="testZipCode" value="33139" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Service Category</label>
                            <select id="testServiceCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Boat Maintenance">Boat Maintenance</option>
                                <option value="Marine Systems">Marine Systems</option>
                                <option value="Engines and Generators">Engines and Generators</option>
                                <option value="Boat and Yacht Repair">Boat and Yacht Repair</option>
                                <option value="Boat Hauling and Yacht Delivery">Boat Hauling and Yacht Delivery</option>
                                <option value="Boat Towing">Boat Towing</option>
                                <option value="Boat Charters and Rentals">Boat Charters and Rentals</option>
                            </select>
                        </div>
                        <button onclick="testVendorMatching()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            Test Matching
                        </button>
                        <div id="matchingResults" class="bg-gray-800 text-white rounded-lg p-4 min-h-[200px] overflow-x-auto">
                            <p class="text-gray-400">No tests run yet</p>
                        </div>
                    </div>
                </div>

                <!-- Process Unassigned Leads - NEW FUNCTIONALITY -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Process Unassigned Leads</h3>
                    <div class="space-y-4">
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-medium text-purple-900 mb-2">Bulk Lead Assignment</h4>
                            <p class="text-sm text-purple-700 mb-3">
                                Find unmatched leads in GoHighLevel and automatically assign them to available vendors using the enhanced routing system.
                            </p>
                            <div class="space-y-2 text-xs text-purple-600">
                                <div>• Searches for leads without assigned vendors</div>
                                <div>• Applies intelligent service category matching</div>
                                <div>• Uses dual routing algorithm for optimal assignment</div>
                                <div>• Updates both local database and GoHighLevel</div>
                            </div>
                        </div>
                        
                        <button onclick="processUnassignedLeads()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Process Unassigned Leads
                        </button>
                        
                        <div id="unassignedLeadsResult" class="bg-gray-800 text-white rounded-lg p-4 min-h-[160px] overflow-x-auto">
                            <p class="text-gray-400">Ready to process unassigned leads</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vendor Management Tab -->
        <div id="vendorsTab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Vendor Management</h3>
                    <button onclick="loadVendors()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        Refresh Vendors
                    </button>
                </div>
                <div id="vendorsList" class="overflow-x-auto">
                    <p class="text-gray-500">Loading vendors...</p>
                </div>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="configurationTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- API Configuration -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">GoHighLevel API Configuration</h3>
                    <form id="apiConfigForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location ID</label>
                            <input type="text" id="locationId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your GHL Location ID">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Private Integration Token</label>
                            <input type="password" id="privateToken" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="pit-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Agency API Key (Optional)</label>
                            <input type="password" id="agencyApiKey" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="For user creation features">
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="testGHLConnection()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                Test Connection
                            </button>
                            <button type="button" onclick="saveAPIConfig()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                Save Configuration
                            </button>
                        </div>
                    </form>
                    <div id="apiTestResult" class="mt-4"></div>
                </div>

                <!-- System Status -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">System Status</h3>
                    <div id="systemStatusDetails" class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600">Webhook System</span>
                            <span class="status-indicator">Checking...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600">Database Connection</span>
                            <span class="status-indicator">Checking...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600">Field Reference</span>
                            <span class="status-indicator">Checking...</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-600">Service Categories</span>
                            <span class="status-indicator">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fields Tab -->
        <div id="fieldsTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Field Management -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Custom Field Management</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-medium text-blue-900 mb-2">Generate Field Reference</h4>
                            <p class="text-sm text-blue-700 mb-3">Automatically scan your GHL location and generate field_reference.json</p>
                            <button onclick="generateFieldReference()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                Generate field_reference.json
                            </button>
                        </div>
                        
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h4 class="font-medium text-green-900 mb-2">Create Missing Fields</h4>
                            <p class="text-sm text-green-700 mb-3">Upload CSV file to automatically create missing custom fields</p>
                            <div class="space-y-2">
                                <input type="file" id="csvFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                <button onclick="createFieldsFromCSV()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                    Create Fields from CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="fieldOperationResult" class="mt-4"></div>
                </div>

                <!-- Current Fields -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Custom Fields</h3>
                    <div id="currentFields" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Loading fields...</p>
                    </div>
                    <button onclick="loadCurrentFields()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                        Refresh Fields
                    </button>
                </div>
            </div>
        </div>

        <!-- Monitoring Tab -->
        <div id="monitoringTab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Recent Activity -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                        <button onclick="loadRecentActivity()" class="text-sm text-blue-600 hover:underline">Refresh</button>
                    </div>
                    <div id="recentActivity" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Loading activity...</p>
                    </div>
                </div>

                <!-- Service Categories -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Active Service Categories</h3>
                    <div id="serviceCategories" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Loading categories...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'routing';
        const baseURL = window.location.origin;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            loadDashboardStats();
            loadRoutingConfiguration();
            loadCurrentFields();
        });

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active', 'bg-blue-600', 'text-white');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('tab-active', 'bg-blue-600', 'text-white');
            event.target.classList.remove('text-gray-500', 'hover:text-gray-700');
            currentTab = tabName;
            
            if (tabName === 'routing') {
                loadRoutingConfiguration();
            } else if (tabName === 'vendors') {
                loadVendors();
            } else if (tabName === 'monitoring') {
                loadRecentActivity();
                loadServiceCategories();
            }
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Routing Configuration Functions
        async function loadRoutingConfiguration() {
            try {
                const response = await fetch(`${baseURL}/api/v1/routing/configuration`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const config = data.data.routing_configuration;
                    const performancePercent = config.performance_percentage || 0;
                    
                    // Update slider
                    const slider = document.getElementById('routingSlider');
                    slider.value = performancePercent;
                    updateRoutingDisplay(performancePercent);
                    
                    // Update stats
                    document.getElementById('totalVendors').textContent = data.data.total_vendors || 0;
                    document.getElementById('activeVendors').textContent = data.data.vendors_taking_work || 0;
                    document.getElementById('locationStatus').textContent = data.data.location_service_status || 'Unknown';
                }
            } catch (error) {
                console.error('Error loading routing configuration:', error);
            }
        }

        function updateRoutingDisplay(performancePercent) {
            const roundRobinPercent = 100 - performancePercent;
            
            document.getElementById('roundRobinPercent').textContent = roundRobinPercent + '%';
            document.getElementById('performancePercent').textContent = performancePercent + '%';
            
            // Update slider background
            const slider = document.getElementById('routingSlider');
            slider.style.setProperty('--value', performancePercent + '%');
            
            // Update strategy description
            let strategy = '';
            if (performancePercent === 0) {
                strategy = '100% Round Robin - Fair distribution among all vendors';
            } else if (performancePercent === 100) {
                strategy = '100% Performance Based - Routes to highest performing vendors';
            } else {
                strategy = `${roundRobinPercent}% Round Robin, ${performancePercent}% Performance Based - Hybrid approach`;
            }
            
            document.getElementById('routingStrategy').textContent = strategy;
        }

        async function saveRoutingConfiguration(performancePercent) {
            try {
                const response = await fetch(`${baseURL}/api/v1/routing/configuration`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        performance_percentage: parseInt(performancePercent)
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showNotification('Routing configuration saved successfully', 'success');
                } else {
                    showNotification('Failed to save routing configuration', 'error');
                }
            } catch (error) {
                console.error('Error saving routing configuration:', error);
                showNotification('Error saving routing configuration', 'error');
            }
        }

        async function testVendorMatching() {
            const zipCode = document.getElementById('testZipCode').value;
            const serviceCategory = document.getElementById('testServiceCategory').value;
            
            try {
                const response = await fetch(`${baseURL}/api/v1/routing/test-matching`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        zip_code: zipCode,
                        service_category: serviceCategory
                    })
                });
                
                const data = await response.json();
                document.getElementById('matchingResults').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                console.error('Error testing vendor matching:', error);
                document.getElementById('matchingResults').innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        }

        // NEW: Process Unassigned Leads Functionality
        async function processUnassignedLeads() {
            const resultElement = document.getElementById('unassignedLeadsResult');
            
            // Show loading state
            resultElement.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div>
                    <span class="ml-3 text-purple-300">Processing unassigned leads...</span>
                </div>
            `;
            
            try {
                const response = await fetch(`${baseURL}/api/v1/routing/process-unassigned-leads`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const successMessage = `✅ Successfully processed ${data.data.processed_leads} leads
✅ Successful assignments: ${data.data.successful_assignments}
❌ Failed assignments: ${data.data.failed_assignments}

📊 Processing Details:
${data.data.leads.map((lead, index) => 
    `${index + 1}. ${lead.customer_name} (${lead.service_category})
   ${lead.assignment_successful ? '✅ Assigned to: ' + (lead.assigned_vendor?.name || 'Unknown') : '❌ Failed: ' + (lead.error_message || 'Unknown error')}`
).join('\n')}`;

                    resultElement.innerHTML = `<pre class="text-green-300 text-sm">${successMessage}</pre>`;
                    showNotification(`Processed ${data.data.processed_leads} leads: ${data.data.successful_assignments} assigned`, 'success');
                } else {
                    resultElement.innerHTML = `<pre class="text-red-300 text-sm">❌ Error: ${data.message}</pre>`;
                    showNotification('Failed to process unassigned leads', 'error');
                }
            } catch (error) {
                console.error('Error processing unassigned leads:', error);
                resultElement.innerHTML = `<pre class="text-red-300 text-sm">❌ Network Error: ${error.message}</pre>`;
                showNotification('Error processing unassigned leads: ' + error.message, 'error');
            }
        }

        // Original Dashboard Functions
        async function checkSystemStatus() {
            try {
                showSystemStatusMessage('🔍 Running comprehensive system health check...', 'info');
                const response = await fetch(`${baseURL}/api/v1/webhooks/health`);
                const data = await response.json();
                updateSystemStatus(data);
                updateSystemStatusDetails(data);
                if (data.status === 'healthy') {
                    showSystemStatusMessage('✅ System health check completed successfully! All components operational.', 'success');
                } else {
                    showSystemStatusMessage('⚠️ System health check completed with warnings. Some components need attention.', 'warning');
                }
            } catch (error) {
                updateSystemStatus({ status: 'error', message: 'Connection failed' });
                showSystemStatusMessage('❌ System health check failed: ' + error.message, 'error');
            }
        }

        function updateSystemStatus(data) {
            const statusEl = document.getElementById('systemStatus');
            statusEl.innerHTML = '';
            if (data.status === 'healthy') {
                statusEl.className = 'px-4 py-2 rounded-full text-sm font-medium status-healthy text-white';
                statusEl.innerHTML = '✅ System Healthy';
            } else if (data.status === 'degraded') {
                statusEl.className = 'px-4 py-2 rounded-full text-sm font-medium status-warning text-white';
                statusEl.innerHTML = '⚠️ System Degraded';
            } else {
                statusEl.className = 'px-4 py-2 rounded-full text-sm font-medium status-error text-white';
                statusEl.innerHTML = '❌ System Error';
            }
        }

        function updateSystemStatusDetails(data) {
            const indicators = document.querySelectorAll('.status-indicator');
            const statuses = [
                data.webhook_system === 'enhanced_dynamic_processing' ? 'healthy' : 'error',
                data.database_status === 'healthy' ? 'healthy' : 'error',
                data.field_reference_status === 'loaded' ? 'healthy' : 'error',
                data.service_categories > 15 ? 'healthy' : 'warning'
            ];
            indicators.forEach((indicator, index) => {
                const status = statuses[index];
                if (status === 'healthy') indicator.innerHTML = '<span class="text-green-600 font-medium">✅ Healthy</span>';
                else if (status === 'warning') indicator.innerHTML = '<span class="text-yellow-600 font-medium">⚠️ Warning</span>';
                else indicator.innerHTML = '<span class="text-red-600 font-medium">❌ Error</span>';
            });
        }

        function showSystemStatusMessage(message, type) {
            let messageEl = document.getElementById('systemStatusMessage');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'systemStatusMessage';
                messageEl.className = 'mt-4 p-3 rounded-lg text-sm';
                document.querySelector('#systemStatusDetails').appendChild(messageEl);
            }
            const colors = {
                success: 'bg-green-50 border border-green-200 text-green-800',
                error: 'bg-red-50 border border-red-200 text-red-800',
                warning: 'bg-yellow-50 border border-yellow-200 text-yellow-800',
                info: 'bg-blue-50 border border-blue-200 text-blue-800'
            };
            messageEl.className = `mt-4 p-3 rounded-lg text-sm ${colors[type]}`;
            messageEl.textContent = message;
            if (type === 'info') setTimeout(() => { if (messageEl) messageEl.remove(); }, 5000);
        }

        async function loadDashboardStats() {
            try {
                const [healthResponse, categoriesResponse, statsResponse] = await Promise.all([
                    fetch(`${baseURL}/api/v1/webhooks/health`),
                    fetch(`${baseURL}/api/v1/webhooks/service-categories`),
                    fetch(`${baseURL}/api/v1/simple-admin/stats`)
                ]);
                const healthData = await healthResponse.json();
                const categoriesData = await categoriesResponse.json();
                const statsData = await statsResponse.json();
                document.getElementById('formsCount').textContent = categoriesData.total_categories || 17;
                document.getElementById('fieldsCount').textContent = healthData.custom_field_mappings || 0;
                if (statsData.status === 'success') {
                    document.getElementById('vendorsCount').textContent = statsData.data.vendors || 0;
                    document.getElementById('leadsCount').textContent = statsData.data.leads || 0;
                }
            } catch (error) { 
                console.error('Error loading stats:', error); 
            }
        }

        async function testGHLConnection() {
            const locationId = document.getElementById('locationId').value;
            const privateToken = document.getElementById('privateToken').value;
            if (!locationId || !privateToken) {
                showResult('apiTestResult', 'error', 'Please fill in Location ID and Private Token');
                return;
            }
            showResult('apiTestResult', 'info', 'Testing connection...');
            try {
                const response = await fetch(`${baseURL}/api/v1/admin/test-ghl-connection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locationId, privateToken })
                });
                const data = await response.json();
                if (data.success) {
                    showResult('apiTestResult', 'success', 'Connection successful! Found ' + (data.fieldCount || 0) + ' custom fields.');
                } else {
                    showResult('apiTestResult', 'error', 'Connection failed: ' + data.error);
                }
            } catch (error) { 
                showResult('apiTestResult', 'error', 'Connection test failed: ' + error.message); 
            }
        }

        async function generateFieldReference() {
            showResult('fieldOperationResult', 'info', 'Generating field reference...');
            try {
                const response = await fetch(`${baseURL}/api/v1/admin/generate-field-reference`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showResult('fieldOperationResult', 'success', `Successfully generated field_reference.json with ${data.fieldCount} fields.`);
                    loadCurrentFields();
                } else {
                    showResult('fieldOperationResult', 'error', 'Failed to generate field reference: ' + data.detail);
                }
            } catch (error) { 
                showResult('fieldOperationResult', 'error', 'Error generating field reference: ' + error.message); 
            }
        }
        
        async function loadRecentActivity() {
            try {
                const response = await fetch(`${baseURL}/api/v1/admin/recent-activity`);
                const data = await response.json();
                const activityContainer = document.getElementById('recentActivity');
                if (data.success && data.activities && data.activities.length > 0) {
                    let activityHTML = '';
                    data.activities.forEach(activity => {
                        const timeAgo = new Date(activity.timestamp).toLocaleString();
                        const statusColor = activity.success ? 'text-green-600' : 'text-red-600';
                        activityHTML += `
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-gray-900">${activity.event_type.replace(/_/g, ' ')}</span>
                                    <span class="text-xs text-gray-500">${timeAgo}</span>
                                </div>
                                <div class="text-sm ${statusColor} mt-1">
                                    ${activity.success ? '✅ Success' : `❌ ${activity.error_message || 'Failed'}`}
                                </div>
                            </div>`;
                    });
                    activityContainer.innerHTML = activityHTML;
                } else {
                    activityContainer.innerHTML = '<p class="text-gray-500">No recent activity found.</p>';
                }
            } catch (error) { 
                document.getElementById('recentActivity').innerHTML = '<p class="text-red-500">Error loading activity.</p>'; 
            }
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            const colors = {
                success: 'bg-green-900/50 border-green-500 text-green-200',
                error: 'bg-red-900/50 border-red-500 text-red-200',
                info: 'bg-blue-900/50 border-blue-500 text-blue-200'
            };
            element.innerHTML = `
                <div class="p-4 border rounded-lg ${colors[type] || colors['info']}">
                    <pre class="whitespace-pre-wrap text-sm font-mono">${message}</pre>
                </div>`;
        }
        
        async function createFieldsFromCSV() {
            const fileInput = document.getElementById("csvFile");
            const file = fileInput.files[0];
            
            if (!file) {
                showResult("fieldOperationResult", "error", "Please select a CSV file");
                return;
            }
            
            showResult("fieldOperationResult", "info", "Creating fields from CSV...");
            
            const formData = new FormData();
            formData.append("csvFile", file);
            
            try {
                const response = await fetch(`${baseURL}/api/v1/admin/create-fields-from-csv`, {
                    method: "POST",
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult("fieldOperationResult", "success", 
                        `Successfully processed CSV. Created: ${data.created}, Skipped: ${data.skipped}, Errors: ${data.errors}`);
                    loadCurrentFields();
                } else {
                    showResult("fieldOperationResult", "error", "Failed to process CSV: " + data.detail);
                }
            } catch (error) {
                showResult("fieldOperationResult", "error", "Error processing CSV: " + error.message);
            }
        }

        async function loadCurrentFields() {
            try {
                const response = await fetch(`${baseURL}/api/v1/webhooks/field-mappings`);
                const data = await response.json();
                const fieldsContainer = document.getElementById("currentFields");
                
                if (data.status === "success") {
                    const fields = data.custom_field_mappings;
                    let fieldsHTML = "";
                    
                    Object.entries(fields).forEach(([fieldKey, fieldData]) => {
                        const dataType = fieldData.dataType || "TEXT";
                        const typeColors = {
                            TEXT: "bg-blue-100 text-blue-800",
                            LARGE_TEXT: "bg-purple-100 text-purple-800",
                            NUMERICAL: "bg-green-100 text-green-800",
                            DATE: "bg-yellow-100 text-yellow-800",
                            RADIO: "bg-pink-100 text-pink-800"
                        };
                        const colorClass = typeColors[dataType] || "bg-gray-100 text-gray-800";
                        
                        fieldsHTML += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <span class="font-medium text-gray-900">${fieldData.name}</span>
                                    <span class="text-xs text-gray-500 ml-2">${fieldKey}</span>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${colorClass}">
                                    ${dataType}
                                </span>
                            </div>
                        `;
                    });
                    
                    fieldsContainer.innerHTML = fieldsHTML || '<p class="text-gray-500">No custom fields found</p>';
                } else {
                    fieldsContainer.innerHTML = '<p class="text-red-500">Error loading fields</p>';
                }
            } catch (error) {
                document.getElementById("currentFields").innerHTML = '<p class="text-red-500">Error loading fields</p>';
            }
        }

        async function loadServiceCategories() {
            try {
                const response = await fetch(`${baseURL}/api/v1/webhooks/service-categories`);
                const data = await response.json();
                const categoriesContainer = document.getElementById("serviceCategories");
                
                if (data.status === "success") {
                    let categoriesHTML = "";
                    
                    Object.entries(data.service_categories).forEach(([categoryKey, categoryData]) => {
                        const subcategoriesCount = categoryData.subcategories ? categoryData.subcategories.length : 0;
                        categoriesHTML += `
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="font-medium text-gray-900">${categoryData.name}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    ${subcategoriesCount} subcategories • ${categoryData.keywords.length} keywords
                                </div>
                            </div>
                        `;
                    });
                    
                    categoriesContainer.innerHTML = categoriesHTML;
                } else {
                    categoriesContainer.innerHTML = '<p class="text-red-500">Error loading categories</p>';
                }
            } catch (error) {
                document.getElementById("serviceCategories").innerHTML = '<p class="text-red-500">Error loading categories</p>';
            }
        }

        async function loadVendors() {
            try {
                const response = await fetch(`${baseURL}/api/v1/simple-admin/vendors`);
                const data = await response.json();
                const vendorsContainer = document.getElementById("vendorsList");
                
                if (data.status === "success" && data.data.length > 0) {
                    let vendorsHTML = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taking Work</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    
                    data.data.forEach(vendor => {
                        const statusColors = {
                            active: "bg-green-100 text-green-800",
                            pending: "bg-yellow-100 text-yellow-800",
                            inactive: "bg-red-100 text-red-800"
                        };
                        const statusClass = statusColors[vendor.status] || "bg-gray-100 text-gray-800";
                        
                        const performancePercent = vendor.performance_score 
                            ? (vendor.performance_score * 100).toFixed(0) 
                            : vendor.lead_close_percentage || 0;
                        
                        vendorsHTML += `
                            <tr id="vendor-row-${vendor.id}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">${vendor.name}</div>
                                        <div class="text-sm text-gray-500">${vendor.email}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${vendor.company_name || "Not specified"}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                        ${vendor.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${performancePercent}%
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <label class="flex items-center cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            ${vendor.taking_new_work ? 'checked' : ''} 
                                            onchange="toggleVendorWork('${vendor.id}', this.checked)"
                                            class="form-checkbox h-4 w-4 text-blue-600"
                                        />
                                        <span class="ml-2 text-sm vendor-status-text ${vendor.taking_new_work ? 'text-green-600' : 'text-red-600'}">
                                            ${vendor.taking_new_work ? 'Yes' : 'No'}
                                        </span>
                                    </label>
                                </td>
                            </tr>
                        `;
                    });
                    
                    vendorsHTML += "</tbody></table>";
                    vendorsContainer.innerHTML = vendorsHTML;
                } else {
                    vendorsContainer.innerHTML = '<p class="text-gray-500">No vendors found</p>';
                }
            } catch (error) {
                document.getElementById("vendorsList").innerHTML = '<p class="text-red-500">Error loading vendors</p>';
                console.error('Error loading vendors:', error);
            }
        }

        async function toggleVendorWork(vendorId, isChecked) {
            try {
                const response = await fetch(`${baseURL}/api/v1/vendor-toggle/availability`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vendor_id: vendorId,
                        taking_new_work: isChecked
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Update UI immediately
                    const row = document.getElementById(`vendor-row-${vendorId}`);
                    const span = row.querySelector('.vendor-status-text');
                    span.textContent = isChecked ? 'Yes' : 'No';
                    span.className = `ml-2 text-sm vendor-status-text ${isChecked ? 'text-green-600' : 'text-red-600'}`;
                    
                    showNotification(`Vendor availability updated successfully`, 'success');
                } else {
                    // Revert checkbox
                    const checkbox = document.querySelector(`input[onchange*="${vendorId}"]`);
                    checkbox.checked = !isChecked;
                    showNotification('Failed to update vendor', 'error');
                }
                
            } catch (error) {
                // Revert checkbox
                const checkbox = document.querySelector(`input[onchange*="${vendorId}"]`);
                checkbox.checked = !isChecked;
                showNotification('Error updating vendor', 'error');
                console.error('Error:', error);
            }
        }

        function refreshDashboard() {
            checkSystemStatus();
            loadDashboardStats();
            
            if (currentTab === 'fields') {
                loadCurrentFields();
            } else if (currentTab === 'monitoring') {
                loadRecentActivity();
                loadServiceCategories();
            } else if (currentTab === 'vendors') {
                loadVendors();
            } else if (currentTab === 'routing') {
                loadRoutingConfiguration();
            }
        }

        // Placeholder functions for API config
        function saveAPIConfig() {
            showNotification('API configuration save functionality coming soon', 'info');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = '/login';
            }
        }
    </script>
</body>
</html>