<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Scope Fix</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        iframe { width: 100%; height: 600px; border: 2px solid #ccc; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; }
        button { margin: 5px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Test Scope Fix for Vendor Application API</h1>
    
    <div>
        <button onclick="checkData()">Check Data Loaded</button>
        <button onclick="selectCategory()">Select Boat Maintenance</button>
        <button onclick="checkSubcategories()">Check Subcategories</button>
    </div>
    
    <div id="log" class="log">Waiting...</div>
    
    <iframe id="app" src="http://localhost:8000/vendor-application-api"></iframe>
    
    <script>
        const logDiv = document.getElementById('log');
        let appWindow;
        
        window.onload = function() {
            setTimeout(() => {
                appWindow = document.getElementById('app').contentWindow;
                log('Page loaded. Waiting for data to load...');
                
                // Check after a delay
                setTimeout(() => {
                    checkData();
                }, 2000);
            }, 1000);
        };
        
        function log(msg) {
            logDiv.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + msg;
        }
        
        function checkData() {
            try {
                if (appWindow.SERVICE_CATEGORIES) {
                    const count = Object.keys(appWindow.SERVICE_CATEGORIES).length;
                    log(`✅ SERVICE_CATEGORIES loaded: ${count} categories`);
                    
                    if (appWindow.SERVICE_CATEGORIES['Boat Maintenance']) {
                        const bm = appWindow.SERVICE_CATEGORIES['Boat Maintenance'];
                        log(`✅ Boat Maintenance found: ${bm.subcategories ? bm.subcategories.length : 0} subcategories`);
                    }
                } else {
                    log('❌ SERVICE_CATEGORIES not found');
                }
            } catch (e) {
                log('❌ Error: ' + e.message);
            }
        }
        
        function selectCategory() {
            try {
                const dropdown = appWindow.document.getElementById('primary_service_category');
                if (dropdown) {
                    // Find and select Boat Maintenance
                    for (let i = 0; i < dropdown.options.length; i++) {
                        if (dropdown.options[i].value === 'Boat Maintenance') {
                            dropdown.selectedIndex = i;
                            dropdown.dispatchEvent(new Event('change', { bubbles: true }));
                            log('✅ Selected Boat Maintenance');
                            setTimeout(checkSubcategories, 500);
                            return;
                        }
                    }
                    log('❌ Boat Maintenance not found in dropdown');
                } else {
                    log('❌ Dropdown not found');
                }
            } catch (e) {
                log('❌ Error: ' + e.message);
            }
        }
        
        function checkSubcategories() {
            try {
                const container = appWindow.document.getElementById('primary-services-container');
                if (container) {
                    const tags = container.querySelectorAll('.service-tag');
                    if (tags.length > 0) {
                        log(`✅ Found ${tags.length} subcategory tags`);
                        const samples = Array.from(tags).slice(0, 3).map(t => t.textContent);
                        log(`First 3: ${samples.join(', ')}`);
                    } else {
                        log('❌ No subcategory tags found');
                        log('Container HTML: ' + container.innerHTML.substring(0, 100));
                    }
                } else {
                    log('❌ Container not found');
                }
            } catch (e) {
                log('❌ Error: ' + e.message);
            }
        }
    </script>
</body>
</html>